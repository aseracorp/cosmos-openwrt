# Beware! This script will be in /rom/etc/uci-defaults/ as part of the image.

# log potential errors
exec >/tmp/09-btrfs-partition.log 2>&1

# additional storage for cosmos? ("$storage"=internal eMMC)
storage="mmcblk0"

echo "add 3rd partition (btrfs) on empty space"
# add 3rd partition after 1024MB
echo "n
p
3
2097153

w
"|fdisk /dev/"$storage"
#format partition
mkfs.btrfs /dev/"$storage"p3 -qf
#set btrfs docker storage driver
uci set dockerd.globals.storage_driver="btrfs"
# mount btrfs partition to docker dir
block detect | uci import fstab
uci set fstab.@mount[-1].target='/opt/docker'
uci set fstab.@mount[-1].enabled='1'
uci set fstab.@mount[-1].options='compress=zstd:10'
uci commit fstab
uci commit dockerd

echo "All done!"
exit 0